<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment - EdenForge</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=GBP"></script> <!-- Replace YOUR_CLIENT_ID -->
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      margin-bottom: 20px;
      text-align: center;
    }
    .section {
      margin-bottom: 30px;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 6px;
      background: #fafafa;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 14px;
    }
    #cart-summary div {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    #cart-summary div:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 16px;
    }
    #paypal-button-container {
      margin-top: 20px;
      text-align: center;
    }
    .error {
      color: red;
      font-size: 13px;
      margin-top: -12px;
      margin-bottom: 12px;
    }
    #submit-message {
      margin-top: 15px;
      font-weight: 600;
      text-align: center;
    }
    #submit-btn {
      background: #0070ba;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 0 auto;
    }
    #submit-btn:disabled {
      background: grey;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <h1>EdenForge Payment</h1>

  <div class="section" id="cart-section">
    <h2>Your Order</h2>
    <div id="cart-summary"></div>
    <p style="text-align: right; font-weight: 700; font-size: 18px;">Total: £<span id="checkout-total">0.00</span></p>
  </div>

  <form id="payment-form" novalidate>
    <div class="section" id="shipping-section">
      <h2>Shipping Details</h2>

      <label for="shipFullName">Full Name *</label>
      <input type="text" id="shipFullName" name="shipFullName" required />
      <div class="error" id="error-shipFullName"></div>

      <label for="shipEmail">Email Address *</label>
      <input type="email" id="shipEmail" name="shipEmail" required />
      <div class="error" id="error-shipEmail"></div>

      <label for="shipAddress">Address *</label>
      <textarea id="shipAddress" name="shipAddress" rows="3" required></textarea>
      <div class="error" id="error-shipAddress"></div>

      <label for="shipCity">City *</label>
      <input type="text" id="shipCity" name="shipCity" required />
      <div class="error" id="error-shipCity"></div>

      <label for="shipPostcode">Postcode *</label>
      <input type="text" id="shipPostcode" name="shipPostcode" required />
      <div class="error" id="error-shipPostcode"></div>
    </div>

    <div class="section" id="billing-section">
      <h2>Billing Details</h2>

      <label for="billFullName">Full Name *</label>
      <input type="text" id="billFullName" name="billFullName" required />
      <div class="error" id="error-billFullName"></div>

      <label for="billEmail">Email Address *</label>
      <input type="email" id="billEmail" name="billEmail" required />
      <div class="error" id="error-billEmail"></div>

      <label for="billAddress">Address *</label>
      <textarea id="billAddress" name="billAddress" rows="3" required></textarea>
      <div class="error" id="error-billAddress"></div>

      <label for="billCity">City *</label>
      <input type="text" id="billCity" name="billCity" required />
      <div class="error" id="error-billCity"></div>

      <label for="billPostcode">Postcode *</label>
      <input type="text" id="billPostcode" name="billPostcode" required />
      <div class="error" id="error-billPostcode"></div>
    </div>

    <button type="button" id="submit-btn">Submit Details & Enable Payment</button>
  </form>

  <div id="paypal-button-container" style="display:none;"></div>

  <div id="submit-message"></div>

  <script>
    const cart = JSON.parse(localStorage.getItem("edenforge_cart")) || [];
    const cartSummary = document.getElementById("cart-summary");
    const totalElement = document.getElementById("checkout-total");
    const submitMessage = document.getElementById("submit-message");
    const paypalContainer = document.getElementById("paypal-button-container");
    const form = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit-btn");

    let total = 0;
    let paypalButtonsRendered = false;

    // Show cart items & total
    if (cart.length === 0) {
      cartSummary.innerHTML = "<p>Your cart is empty.</p>";
      totalElement.textContent = "0.00";
      submitBtn.disabled = true;
    } else {
      cart.forEach(item => {
        const div = document.createElement("div");
        div.innerHTML = `<span>${item.name} x ${item.quantity}</span><span>£${(item.price * item.quantity).toFixed(2)}</span>`;
        cartSummary.appendChild(div);
        total += item.price * item.quantity;
      });
      totalElement.textContent = total.toFixed(2);
    }

    // Validate form fields
    function validateFields(fields) {
      let valid = true;
      fields.forEach(field => {
        const input = document.getElementById(field);
        const errorDiv = document.getElementById("error-" + field);
        if (!input.value.trim()) {
          errorDiv.textContent = "This field is required.";
          valid = false;
        } else {
          errorDiv.textContent = "";
          if (field.toLowerCase().includes("email")) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!re.test(input.value.trim())) {
              errorDiv.textContent = "Please enter a valid email.";
              valid = false;
            }
          }
        }
      });
      return valid;
    }

    function validateAll() {
      const shippingFields = ["shipFullName", "shipEmail", "shipAddress", "shipCity", "shipPostcode"];
      const billingFields = ["billFullName", "billEmail", "billAddress", "billCity", "billPostcode"];
      return validateFields(shippingFields) && validateFields(billingFields);
    }

    function renderPayPalButton() {
      if (paypalButtonsRendered) return; // Prevent re-rendering
      paypalButtonsRendered = true;
      paypalContainer.style.display = "block";

      paypal.Buttons({
        createOrder: function(data, actions) {
          // Use billing address for PayPal shipping here (adjust if needed)
          return actions.order.create({
            purchase_units: [{
              amount: { value: total.toFixed(2) },
              shipping: {
                name: { full_name: document.getElementById("shipFullName").value.trim() },
                address: {
                  address_line_1: document.getElementById("shipAddress").value.trim(),
                  admin_area_2: document.getElementById("shipCity").value.trim(),
                  postal_code: document.getElementById("shipPostcode").value.trim(),
                  country_code: "GB"
                }
              }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            submitMessage.style.color = "green";
            submitMessage.textContent = `Thank you, ${details.payer.name.given_name}! Your payment was successful.`;
            localStorage.removeItem("edenforge_cart");
            setTimeout(() => {
              window.location.href = "thankyou.html";
            }, 2500);
          });
        },
        onError: function(err) {
          submitMessage.style.color = "red";
          submitMessage.textContent = "Payment failed. Please try again.";
          console.error(err);
        }
      }).render("#paypal-button-container");
    }

    // Submit button handler to validate form & enable PayPal
    submitBtn.addEventListener("click", () => {
      submitMessage.textContent = "";
      if (validateAll()) {
        submitMessage.style.color = "green";
        submitMessage.textContent = "Details submitted successfully! You can now complete your payment below.";
        renderPayPalButton();
        submitBtn.disabled = true;
        // Optionally disable inputs here if you want:
        // [...form.elements].forEach(el => el.disabled = true);
      } else {
        submitMessage.style.color = "red";
        submitMessage.textContent = "Please correct the errors above before submitting.";
      }
    });
  </script>

</body>
</html>


